"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=_default;var maskEl,_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_moment=_interopRequireDefault(require("moment")),_lodash=_interopRequireDefault(require("lodash")),_uiUtil=require("@ctmobile/ui-util"),selectorPrefix="ct-pullrefresh-",dataFormatStr="YYYY-MM-DD HH:mm:ss",template=_lodash.default.template('<div class="'.concat(selectorPrefix,'inner">\n      <%if(icon){%>\n        <div class="').concat(selectorPrefix,'icon" style="background: none;"><img src="<%=icon%>"></div>\n      <%} else {%>\n        <div class="').concat(selectorPrefix,'icon"></div>  \n      <%}%>\n      <p class="').concat(selectorPrefix,'label"><%=label%></p>\n      <%if(showUpdate) {%>\n      <p class="').concat(selectorPrefix,'update">更新时间：<span class="').concat(selectorPrefix,'update-label">').concat((0,_moment.default)().format(dataFormatStr),'</span></p>\n      <%}%>\n   </div>\n   <%if(loadingAnimation) {%>\n    <div class="').concat(selectorPrefix,'refresh">\n      <%=loadingAnimation%>\n    </div>\n   <%} else {%>\n    <div class="').concat(selectorPrefix,'refresh la-ball-circus la-dark">\n      <div></div>\n      <div></div>\n      <div></div>\n      <div></div>\n      <div></div>\n   </div>\n   <%}%>\n   '));function translateY(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,l=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;e.style.transition=e.style.webkitTransition="transform ".concat(l,"ms ease"),e.style.transform=e.style.webkitTransform="translate3d(0,".concat(t,"px,0)")}function rotateIcon(e,t){var l=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,s=t;e.style.transition=e.style.webkitTransition="transform ".concat(l,"ms linear"),e.style.transform=e.style.webkitTransform="rotate(".concat(s,"deg)")}function clear(){this.scrollEl.removeEventListener("mousemove",this.onTouchMove),this.scrollEl.removeEventListener("mouseup",this.onTouchEnd),this.scrollEl.removeEventListener("touchmove",this.onTouchMove),this.scrollEl.removeEventListener("touchend",this.onTouchEnd),this.downpull=!1,this.isTop=!0,this.pullEl.style.display="flex",this.refreshEl.style.display="none",this.config.icon||rotateIcon(this.iconEl,180,0),this.scrollEl.style.overflowY="auto",maskEl.style.display="none"}function _refresh(){var t=this;maskEl.style.display="block",this.scrollEl.removeEventListener("mousemove",this.onTouchMove),this.scrollEl.removeEventListener("mouseup",this.onTouchEnd),this.scrollEl.removeEventListener("touchmove",this.onTouchMove),this.scrollEl.removeEventListener("touchend",this.onTouchEnd),t.scrollEl.addEventListener("transitionend",function e(){t.pullEl.style.display="none",t.refreshEl.style.display="block",t.events.trigger("pullRefresh",t),t.scrollEl.removeEventListener("transitionend",e)}),translateY(t.scrollEl,t.refreshHeight,500),translateY(t.el,t.refreshHeight,500),t.config.icon||rotateIcon(t.iconEl,180,300)}function _reset(){var t=this;clear.call(t),t.scrollEl.addEventListener("transitionend",function e(){t.scrollEl.removeEventListener("transitionend",e)}),translateY(t.scrollEl,0,200),translateY(t.el,0,200)}var PullRefresh=function(){function p(e){var t=e.scrollEl,l=e.scrollInnerEl,s=e.pullEl,i=e.pullHeight,o=void 0===i?200:i,n=e.icon,r=void 0===n?"":n,a=e.label,c=void 0===a?"下拉刷新":a,h=e.canLabel,u=void 0===h?"松开刷新":h,d=e.showUpdate,v=void 0===d||d,f=e.loadingAnimation,E=void 0===f?"":f;(0,_classCallCheck2.default)(this,p),this.scrollEl=t,this.scrollInnerEl=l,this.el=s,this.config={icon:r,label:c,canLabel:u,showUpdate:v,loadingAnimation:E},(this.pullHeight=o)<=0?this.pullHeight=200:o>this.scrollEl.clientHeight?this.pullHeight=this.scrollEl.clientHeight:this.pullHeight=o,this.el.innerHTML=template(this.config),this.pullEl=this.el.querySelector(".".concat(selectorPrefix,"inner")),this.iconEl=this.el.querySelector(".".concat(selectorPrefix,"icon")),this.labelEl=this.el.querySelector(".".concat(selectorPrefix,"label")),this.updateEl=this.el.querySelector(".".concat(selectorPrefix,"update-label")),this.refreshEl=this.el.querySelector(".".concat(selectorPrefix,"refresh")),this.refreshHeight=this.el.clientHeight,this.onTouchStart=this.onTouchStart.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onScroll=this.onScroll.bind(this),maskEl||(maskEl=_uiUtil.Dom6.createElement("<div class='".concat(selectorPrefix,"mask'></div>")),document.body.appendChild(maskEl)),this.events=new _uiUtil.Events,this.config.showUpdate&&(this.updateTime=(0,_moment.default)().format(dataFormatStr),this.updateEl.innerText=this.updateTime),this.isTop=!0,this.scrollEl.addEventListener("touchstart",this.onTouchStart),this.scrollEl.addEventListener("mousedown",this.onTouchStart),this.scrollEl.addEventListener("scroll",this.onScroll)}return(0,_createClass2.default)(p,[{key:"onTouchStart",value:function(e){this.events.trigger("pullStart"),this.startPageY=e.changedTouches?e.changedTouches[0].pageY:e.pageY,this.scrollEl.addEventListener("touchmove",this.onTouchMove),this.scrollEl.addEventListener("mousemove",this.onTouchMove),this.scrollEl.addEventListener("touchend",this.onTouchEnd),this.scrollEl.addEventListener("mouseup",this.onTouchEnd)}},{key:"onTouchMove",value:function(e){this.scrollEl.style.overflow="hidden";var t=(e.changedTouches?e.changedTouches[0].pageY:e.pageY)-this.startPageY,l=Math.abs(t);0<t?(e.preventDefault(),this.downpull=!0,l<this.pullHeight?(translateY(this.scrollEl,l,0),translateY(this.el,l,0),l>=this.refreshHeight+80?(this.config.icon||rotateIcon(this.iconEl,0,150),console.log("3.具备刷新条件"),this.labelEl.innerText=this.config.canLabel,this.events.trigger("pullCanRefresh")):(this.config.icon||rotateIcon(this.iconEl,180,150),this.labelEl.innerText=this.config.label),this.el.style.display="flex"):(translateY(this.scrollEl,this.pullHeight,0),translateY(this.el,this.pullHeight,0),this.config.icon||rotateIcon(this.iconEl,0,150),console.log("4.拉动到了底部"),this.labelEl.innerText=this.config.canLabel,this.events.trigger("pullBottom"))):this.downpull?(e.preventDefault(),translateY(this.scrollEl,0,0),translateY(this.el,0,0),this.config.icon||rotateIcon(this.iconEl,180,0)):clear.call(this)}},{key:"onTouchEnd",value:function(e){var t=this,l=(e.changedTouches?e.changedTouches[0].pageY:e.pageY)-this.startPageY,s=Math.abs(l);0<l?s<this.pullHeight?s>=this.refreshHeight+80?_refresh.call(t,!1):(console.log("2.没有具备刷新条件弹回"),t.events.trigger("pullRebound"),_reset.call(t)):_refresh.call(t,!0):clear.call(t)}},{key:"onScroll",value:function(e){var t=this;0===e.target.scrollTop?(t.isTop=!0,t.scrollEl.addEventListener("touchstart",this.onTouchStart),t.scrollEl.addEventListener("mousedown",this.onTouchStart)):t.isTop&&(t.isTop=!1,t.scrollEl.removeEventListener("touchstart",this.onTouchStart),t.scrollEl.removeEventListener("mousedown",this.onTouchStart))}},{key:"reset",value:function(){this.config.showUpdate&&(this.updateTime=(0,_moment.default)().format(dataFormatStr),this.updateEl.innerText=this.updateTime),_reset.call(this)}},{key:"refresh",value:function(){_refresh.call(this)}},{key:"on",value:function(e,t){this.events.on(e,t)}},{key:"off",value:function(e,t){e?t?this.events.remove(e,t):this.events.clear(e):this.events.clearAll()}}]),p}();function _default(e){return new PullRefresh(e)}
//# sourceMappingURL=pullrefresh.js.map
